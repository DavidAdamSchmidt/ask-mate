{% extends 'layout.html' %}

{% macro display_table(table, type) %}
    <table>
        <tr>
        {% for header in table[0] %}
            <th>{{ header.capitalize().replace('_', ' ') }}</th>
        {% endfor %}
        </tr>
        {% for row in table %}
            <tr>
                {% for value in row.values() %}
                    {% if value == row.image %}
                        {% if value is none %}
                            <td><p>No picture available</p></td>
                        {% else %}
                            {% set url = url_for('static', filename=value) %}
                            <td><img src="{{ url }}" alt="{{ value }}"></td>
                        {% endif %}
                    {% else %}
                        <td>{{ value }}</td>
                    {% endif %}
                {% endfor %}
                <td class="no-border">
                {% if type in ('answer') %}
                    {% for operation in ('up', 'down') %}
                            {% set url = url_for(
                                'route_answer_votes',
                                answer_id=row.id,
                                operation=operation
                            ) %}
                        <form action="{{ url }}" method="post">
                            <input type="submit" class="{{ operation }}" value="Vote {{ operation }}">
                        </form>
                    {% endfor %}
                {% endif %}
                {% for to_do in ('edit', 'delete') %}
                    {% if type == 'question' %}
                        {% set url = url_for('route_%s_question' % to_do, question_id= row.id) %}
                    {% elif type == 'answer' %}
                        {% set url = url_for('route_%s_answer' % to_do, answer_id= row.id) %}
                    {% elif type == 'comment' and to_do == 'delete' %}
                        {% set url = url_for('route_%s_comment' % to_do, comment_id= row.id) %}
                    {% endif %}
                        <form action="{{ url }}" method="{{ 'post' if to_do == 'edit' else 'get' }}">
                            <input type="submit" class="{{ to_do }}" value="{{ to_do.capitalize() }}">
                        </form>
                {% endfor %}
                </td>
            </tr>
        {% endfor %}
        {% if type == 'question' %}
            <tr>
                <td colspan="2">
                    {{ tag.name if tag and tag.name else 'No rag added yet' }}
                </td>
                <td colspan="3">
                    <a href="{{ url_for('route_add_edit_tag', question_id=table[0].id) }}">
                        Add/Edit Rag
                    </a>
                </td>
                <td colspan="2">
                    <a href="{{ url_for('route_delete_tag', tag=tag.id, question_id=table[0].id) }}">
                        <img id="delete" src="/static/images/delete.png" alt="X">
                    </a>
                </td>
            </tr>
        {% endif %}
    </table>
{% endmacro %}

{% macro add_new(type, suffix='') %}
    <p>
        {% set id = question.id if question else question_id %}
        <a href="{{ url_for('route_add_{}{}'.format(type, suffix), question_id=id) }}">
            Add new {{ type }}
        </a>
    </p>
{% endmacro %}

{% block title %}
    Question details
{% endblock %}

{% block content %}
    <div>
        {% if question %}
            <h1>Question #{{ question.id }}</h1>
            {{ display_table([question], 'question') }}
        {% else %}
            <p>There is no question with id {{ question_id }}</p>
        {% endif %}
        {% if answers %}
            <h2>Answers</h2>
            {{ display_table(answers, 'answer') }}
        {% else %}
            <p>There are no answers for this question</p>
        {% endif %}
        {{ add_new('answer') }}
        {% if comments %}
            <h3>Comments</h3>
            {{ display_table(comments, 'comment') }}
        {% else %}
            <p>There are no comments for this question</p>
        {% endif %}
        {{ add_new('comment', '_to_question') }}
        <p>
            <a href="{{ url_for('route_questions_list') }}">
                Back to homepage
            </a>
        </p>
    </div>
{% endblock %}