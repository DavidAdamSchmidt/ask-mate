{% extends 'layout.html' %}

{% macro display_table(table, type) %}
    <table>
        <tr>
        {% for header in table[0] %}
            <th>
                {{ header.capitalize().replace('_', ' ') }}
            </th>
        {% endfor %}
        </tr>
        {% for row in table %}
            <tr>
                {% for key, value in row.items() %}
                    {% if value == row.image %}
                        {% if value is none %}
                            <td><p>No picture available</p></td>
                        {% else %}
                            {% set url = url_for('static', filename=value) %}
                            <td><img src="{{ url }}" alt="{{ value }}"></td>
                        {% endif %}
                    {% elif key == 'submission_time' and type == 'answer' and 'answer' not in request.path %}
                        <td>
                            <a href="{{ url_for('route_answer_display', answer_id = row.id) }}">
                                {{ value }}
                            </a>
                        </td>
                    {% else %}
                        <td>{{ value }}</td>
                    {% endif %}
                {% endfor %}
                <td class="no-border">
                {% if type not in (main_type, 'comment') %}
                    {% for operation in ('up', 'down') %}
                            {% set url = url_for(
                                'route_answer_votes',
                                answer_id=row.id,
                                operation=operation
                            ) %}
                        <form action="{{ url }}" method="post">
                            <input type="submit" class="{{ operation }}" value="Vote {{ operation }}">
                        </form>
                    {% endfor %}
                {% endif %}
                {% set operations = ('edit', 'delete') if type == 'comment' else ('add', 'edit', 'delete') %}
                {% for to_do in operations %}
                    {% if to_do == 'add' %}
                        {% if type == 'question'  %}
                            {% set url = url_for('route_%s_comment_to_question' % to_do, question_id=row.id) %}
                        {% else %}
                            {% set url = url_for('route_%s_comment_to_answer' % to_do, answer_id=row.id) %}
                        {% endif %}
                    {% elif type == 'question' %}
                        {% set url = url_for('route_%s_question' % to_do, question_id=row.id) %}
                    {% elif type == 'answer' %}
                        {% set url = url_for('route_%s_answer' % to_do, answer_id=row.id) %}
                    {% elif type == 'comment' %}
                        {% set url = url_for('route_%s_comment' % to_do, comment_id=row.id) %}
                    {% endif %}
                        {% set value = to_do.capitalize() + (' comment' if to_do == 'add' else '') %}
                        <form action="{{ url }}" method="post">
                            <input type="submit" class="{{ to_do }}" value="{{ value }}">
                        </form>
                {% endfor %}
                </td>
            </tr>
        {% endfor %}
        {% if type == 'question' %}
            <tr>
                <td colspan="2">
                    {{ tag.name if tag and tag.name else 'No rag added yet' }}
                </td>
                <td colspan="3">
                    <a href="{{ url_for('route_add_edit_tag', question_id=table[0].id) }}">
                        <img class="delit" src="/static/images/add-edit.jpeg" alt="Add/Edit Rag">
                    </a>
                </td>
                <td colspan="2">
                    <a href="{{ url_for('route_delete_tag', tag=tag.id, question_id=table[0].id) }}">
                        <img class="delit" src="/static/images/delete.png" alt="X">
                    </a>
                </td>
            </tr>
        {% endif %}
    </table>
{% endmacro %}

{% block title %}
    {{ 'Question details' if question or question_id else 'Answer details' }}
{% endblock %}

{% block content %}
    <div>
        {% if question %}
            <h1>Question #{{ question.id }}</h1>
            {{ display_table([question], 'question') }}
        {% elif answer %}
            <h1>Answer #{{ answer.id }}</h1>
            {{ display_table([answer], 'answer') }}
        {% else %}
            <p>There is no question with id {{ question_id }}</p>
        {% endif %}
        {% if answers %}
            <h2>Answers</h2>
            {{ display_table(answers, 'answer') }}
        {% elif question or question_id %}
            <p>There are no answers for this question</p>
        {% endif %}
        {% if question or question_id %}
        <p>
            {% set id = question.id if question else question_id %}
            <a href="{{ url_for('route_add_answer', question_id=id) }}">
                Add new answer
            </a>
        </p>
        {% endif %}
        {% if comments %}
            <h3>Comments</h3>
            {{ display_table(comments, 'comment') }}
        {% else %}
            <p>There are no comments for this {{ 'question' if question or question_id else 'answer' }}</p>
        {% endif %}
        <p>
            <a href="{{ url_for('route_questions_list') }}">
                Back to homepage
            </a>
        </p>
    </div>
{% endblock %}